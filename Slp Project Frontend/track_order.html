<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinWorth — Track Order</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/my_order.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .track-order-header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
        }
        
        .track-order-header h1 {
            font-size: 32px;
            margin-bottom: 16px;
            color: #111827;
        }
        
        .track-order-header p {
            color: #6b7280;
            font-size: 18px;
        }
        
        .track-order-form {
            max-width: 600px;
            margin: 0 auto 40px;
            padding: 30px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .btn-block {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 500;
        }
        
        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Hide order list initially */
        .orders-list {
            display: none;
        }
        
        /* Styles for single order view */
        .single-order-view .orders-stats {
            display: none;
        }
        
        .single-order-view .orders-tabs {
            display: none;
        }
        
        .track-back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        
        .track-back-btn:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Same header as index.html -->
    <header class="site-header">
        <div class="brand">
            <a href="index.html">CoinWorth<span class="accent"></span></a>
        </div>
        <div class="search-bar">
            <form id="searchForm" action="search.html" method="get">
                <input id="searchInput" name="q" type="search" placeholder="Search for products, brands and more" />
                <button type="submit">Search</button>
            </form>
        </div>
        <nav class="nav-actions">
            <!-- Will be populated by authManager -->
            <a href="login/signIn.html" class="nav-item">Sign in</a>
        </nav>
    </header>

    <main class="orders-container">
        <!-- Step 1: Track Order Form -->
        <div id="trackOrderStep" class="track-order-step">
            <div class="track-order-header">
                <h1>Track Your Order</h1>
                <p>Enter your order number to check order status</p>
            </div>
            
            <div class="track-order-form">
                <div class="form-group">
                    <label for="orderNumber">Order Number *</label>
                    <input type="text" id="orderNumber" 
                           placeholder="Enter order number from your confirmation email"
                           maxlength="64">
                    <div id="orderError" class="error-message"></div>
                </div>
                
                <div class="info-box" style="background: #eff6ff; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                    <div style="display: flex; gap: 12px; align-items: flex-start;">
                        <div style="font-size: 20px; flex-shrink: 0;">ℹ️</div>
                        <p style="margin: 0; color: #1e40af; font-size: 14px;">
                            You can find your order number in the confirmation email we sent you.
                        </p>
                    </div>
                </div>
                
                <button id="trackOrderBtn" class="btn btn-primary btn-block">
                    Track Order
                </button>
            </div>
        </div>
        
        <!-- Step 2: Loading -->
        <div id="loadingStep" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 16px; color: #6b7280;">Fetching your order details...</p>
        </div>
        
        <!-- Step 3: Order Results (using same UI as my_orders) -->
        <div id="orderResultStep" style="display: none;">
            <!-- Back button -->
            <a id="backToTrack" class="track-back-btn">
                <i class="fas fa-arrow-left"></i> Track Another Order
            </a>
            
            <!-- Same order list container as my_orders -->
            <div class="orders-list" id="ordersList">
                <!-- Order will be rendered here using same format as my_orders -->
            </div>
            
            <!-- No orders state -->
            <div class="no-orders" id="noOrders" style="display: none;">
                <div class="no-orders-icon">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <h2>Order Not Found</h2>
                <p>No order found with this order number. Please check and try again.</p>
                <button id="tryAgainBtn" class="btn btn-primary">Try Another Order Number</button>
            </div>
        </div>
    </main>

    <!-- Same footer as index.html -->
    <footer class="site-footer">
        <div class="footer-content">
            <div>© <span id="year"></span> CoinWorth — Premium E-Commerce Platform</div>
            <div class="footer-tagline">Built for modern shopping experience</div>
        </div>
    </footer>

    <!-- Order Details Modal (same as my_orders) -->
    <div class="modal" id="orderDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Order Details</h2>
                <button class="modal-close" id="closeModal">&times;</button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>

    <script src="js/utils/authManager.js"></script>
    <script src="js/common.js"></script>
    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Update year
            document.getElementById('year').textContent = new Date().getFullYear();
            
            // Initialize auth state
            if (authManager && authManager.updateUIBasedOnAuth) {
                authManager.updateUIBasedOnAuth();
            }
            
            // Initialize track order functionality
            initTrackOrder();
        });
        
        function initTrackOrder() {
            const trackBtn = document.getElementById('trackOrderBtn');
            const orderInput = document.getElementById('orderNumber');
            const orderError = document.getElementById('orderError');
            const trackStep = document.getElementById('trackOrderStep');
            const loadingStep = document.getElementById('loadingStep');
            const orderResultStep = document.getElementById('orderResultStep');
            const backBtn = document.getElementById('backToTrack');
            const tryAgainBtn = document.getElementById('tryAgainBtn');
            
            // Track order button click
            trackBtn.addEventListener('click', async function() {
                const orderNumber = orderInput.value.trim();
                
                if (!orderNumber) {
                    showError(orderError, 'Please enter order number');
                    return;
                }
                
                // Clear error
                hideError(orderError);
                
                // Show loading
                trackStep.style.display = 'none';
                loadingStep.style.display = 'block';
                
                try {
                    // Fetch order from API
                    const order = await fetchOrderDetails(orderNumber);
                    
                    // Hide loading
                    loadingStep.style.display = 'none';
                    
                    if (order) {
                        // Show order with same UI as my_orders
                        displayOrder(order);
                        orderResultStep.style.display = 'block';
                    } else {
                        // Show error
                        trackStep.style.display = 'block';
                        showError(orderError, 'Order not found. Please check order number.');
                    }
                    
                } catch (error) {
                    console.error('Error:', error);
                    loadingStep.style.display = 'none';
                    trackStep.style.display = 'block';
                    showError(orderError, 'Network error. Please try again.');
                }
            });
            
            // Enter key support
            orderInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    trackBtn.click();
                }
            });
            
            // Back button
            backBtn.addEventListener('click', function() {
                orderResultStep.style.display = 'none';
                trackStep.style.display = 'block';
                orderInput.value = '';
                orderInput.focus();
            });
            
            // Try again button
            if (tryAgainBtn) {
                tryAgainBtn.addEventListener('click', function() {
                    document.getElementById('noOrders').style.display = 'none';
                    orderResultStep.style.display = 'none';
                    trackStep.style.display = 'block';
                    orderInput.value = '';
                    orderInput.focus();
                });
            }
            
            // Initialize modal
            initModal();
        }
        
        // Fetch order details from API
        async function fetchOrderDetails(orderNumber) {
            try {
                const response = await fetch(`http://localhost:8000/api/orders/guest-user-get-order/?order_number=${encodeURIComponent(orderNumber)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Order data:', data);
                
                if (data.orders && data.orders.length > 0) {
                    return data.orders[0];
                }
                return null;
                
            } catch (error) {
                console.error('Fetch error:', error);
                throw error;
            }
        }
        
        // Display order using same UI as my_orders
        function displayOrder(order) {
            const ordersList = document.getElementById('ordersList');
            const noOrders = document.getElementById('noOrders');
            
            // Show orders list, hide no orders state
            ordersList.style.display = 'block';
            noOrders.style.display = 'none';
            
            // Create order card using same format as my_orders
            ordersList.innerHTML = createOrderCard(order);
            
            // Add event listeners to view details button
            const viewDetailsBtn = ordersList.querySelector('.view-details');
            if (viewDetailsBtn) {
                viewDetailsBtn.addEventListener('click', function() {
                    showOrderDetails(order);
                });
            }
            
            // Add event listeners to track order button
            const trackOrderBtn = ordersList.querySelector('.track-order');
            if (trackOrderBtn) {
                trackOrderBtn.addEventListener('click', function() {
                    trackSpecificOrder(order.order_number);
                });
            }
        }
        
        // Create order card HTML (same as my_orders)
        function createOrderCard(order) {
            const status = getStatusInfo(order.status);
            const date = new Date(order.created_at).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            
            const time = new Date(order.created_at).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Create items HTML with images
            const itemsHTML = order.items.map(item => createOrderItem(item)).join('');
            
            return `
                <div class="order-card" data-status="${order.status.toLowerCase()}">
                    <div class="order-header">
                        <div class="order-meta">
                            <div class="meta-item">
                                <span class="meta-label">ORDER PLACED</span>
                                <span class="meta-value">${date} at ${time}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">TOTAL</span>
                                <span class="meta-value">₹${parseFloat(order.total).toFixed(2)}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">ORDER #</span>
                                <span class="meta-value">${order.order_number}</span>
                            </div>
                        </div>
                        <div class="order-status">
                            <span class="status-badge ${status.class}">${status.text}</span>
                        </div>
                    </div>
                    
                    <div class="order-body">
                        <div class="order-items">
                            ${itemsHTML}
                        </div>
                        
                        <div class="order-summary">
                            <div class="summary-row">
                                <span>Subtotal</span>
                                <span>₹${parseFloat(order.subtotal || 0).toFixed(2)}</span>
                            </div>
                            <div class="summary-row">
                                <span>Shipping</span>
                                <span>₹${parseFloat(order.shipping_charge || 0).toFixed(2)}</span>
                            </div>
                            <div class="summary-row">
                                <span>Tax</span>
                                <span>₹${parseFloat(order.tax || 0).toFixed(2)}</span>
                            </div>
                            <div class="summary-row total">
                                <span>Total</span>
                                <span>₹${parseFloat(order.total).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="order-footer">
                        <div class="shipping-info">
                            <div class="shipping-label">SHIPPING ADDRESS</div>
                            <div class="shipping-address">
                                ${order.shipping.address_1}, ${order.shipping.city}, ${order.shipping.state} - ${order.shipping.pincode}
                            </div>
                        </div>
                        
                        <div class="order-actions">
                            <button class="action-btn secondary view-details" data-order-number="${order.order_number}">
                                <i class="fas fa-eye"></i> View Details
                            </button>
                            ${order.status === 'DELIVERED' ? `
                                <button class="action-btn secondary buy-again" data-order-number="${order.order_number}">
                                    <i class="fas fa-shopping-cart"></i> Buy Again
                                </button>
                            ` : ''}
                            ${['SHIPPED', 'OUT_FOR_DELIVERY'].includes(order.status) ? `
                                <button class="action-btn primary track-order" data-order-number="${order.order_number}">
                                    <i class="fas fa-map-marker-alt"></i> Track Order
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Create order item HTML with image
        function createOrderItem(item) {
            const imageUrl = item.variant_primary_image?.image || 'assets/default-product.jpg';
            const altText = item.variant_primary_image?.alt_text || 'Product Image';
            
            return `
                <div class="order-item">
                    <div class="item-image">
                        <img src="${imageUrl}" alt="${altText}" loading="lazy"
                             onerror="this.src='assets/default-product.jpg'">
                    </div>
                    <div class="item-details">
                        <div class="item-name">${item.product_name || `Product ${item.product_id}`}</div>
                        <div class="item-meta">
                            <span>Qty: ${item.quantity}</span>
                            ${item.product_variant_id ? `<span>Variant ID: ${item.product_variant_id}</span>` : ''}
                        </div>
                    </div>
                    <div class="item-price">
                        ₹${parseFloat(item.subtotal).toFixed(2)}
                    </div>
                </div>
            `;
        }
        
        // Get status information
        function getStatusInfo(status) {
            const statusMap = {
                'PROCESSING': { class: 'status-processing', text: 'Processing' },
                'CONFIRMED': { class: 'status-confirmed', text: 'Confirmed' },
                'PACKED': { class: 'status-processing', text: 'Packed' },
                'SHIPPED': { class: 'status-shipped', text: 'Shipped' },
                'OUT_FOR_DELIVERY': { class: 'status-shipped', text: 'Out for Delivery' },
                'DELIVERED': { class: 'status-delivered', text: 'Delivered' },
                'CANCELLED': { class: 'status-cancelled', text: 'Cancelled' },
                'RETURN_REQUESTED': { class: 'status-cancelled', text: 'Return Requested' },
                'RETURNED': { class: 'status-cancelled', text: 'Returned' },
                'REFUNDED': { class: 'status-refunded', text: 'Refunded' },
                'CLOSED': { class: 'status-delivered', text: 'Closed' }
            };
            
            return statusMap[status] || { class: 'status-processing', text: status };
        }
        
        // Show order details modal
        function showOrderDetails(order) {
            const modal = document.getElementById('orderDetailsModal');
            const content = document.getElementById('orderDetailsContent');
            
            const status = getStatusInfo(order.status);
            const date = new Date(order.created_at).toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // Build detailed order HTML
            const orderDetailsHTML = `
                <div class="order-details">
                    <div class="detail-section">
                        <h3><i class="fas fa-info-circle"></i> Order Information</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">Order Number</span>
                                <span class="detail-value">${order.order_number}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Order Date</span>
                                <span class="detail-value">${date}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Order Status</span>
                                <span class="status-badge ${status.class}">${status.text}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Payment Method</span>
                                <span class="detail-value">${order.payment_method || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Payment Status</span>
                                <span class="detail-value">${order.payment_status || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3><i class="fas fa-box"></i> Items Ordered (${order.items.length})</h3>
                        <div class="order-items">
                            ${order.items.map(item => createDetailedOrderItem(item)).join('')}
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3><i class="fas fa-receipt"></i> Price Breakdown</h3>
                        <div class="price-breakdown">
                            <div class="summary-row">
                                <span>Subtotal (${order.items.length} items)</span>
                                <span>₹${parseFloat(order.subtotal || 0).toFixed(2)}</span>
                            </div>
                            <div class="summary-row">
                                <span>Shipping Charge</span>
                                <span>₹${parseFloat(order.shipping_charge || 0).toFixed(2)}</span>
                            </div>
                            <div class="summary-row">
                                <span>Tax (GST)</span>
                                <span>₹${parseFloat(order.tax || 0).toFixed(2)}</span>
                            </div>
                            <div class="summary-row total">
                                <span>Grand Total</span>
                                <span>₹${parseFloat(order.total).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3><i class="fas fa-truck"></i> Shipping Information</h3>
                        <div class="shipping-details">
                            <p><strong>Name:</strong> ${order.shipping.name}</p>
                            <p><strong>Phone:</strong> ${order.shipping.phone}</p>
                            <p><strong>Email:</strong> ${order.shipping.email || 'N/A'}</p>
                            <p><strong>Address:</strong> ${order.shipping.address_1} ${order.shipping.address_2 || ''}</p>
                            <p><strong>City:</strong> ${order.shipping.city}</p>
                            <p><strong>State:</strong> ${order.shipping.state}</p>
                            <p><strong>Pincode:</strong> ${order.shipping.pincode}</p>
                        </div>
                    </div>
                    
                    <div class="guest-note">
                        <div class="info-box">
                            <i class="fas fa-info-circle"></i>
                            <p>Note: You are viewing this order as a guest. To track all your orders and get better support, please <a href="login/signIn.html">create an account</a>.</p>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = orderDetailsHTML;
            modal.style.display = 'flex';
            
            // Add close modal functionality
            const closeBtn = modal.querySelector('.modal-close');
            if (closeBtn) {
                closeBtn.onclick = function() {
                    modal.style.display = 'none';
                };
            }
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            };
        }
        
        // Create detailed order item HTML with image
        function createDetailedOrderItem(item) {
            const imageUrl = item.variant_primary_image?.image || 'assets/default-product.jpg';
            const altText = item.variant_primary_image?.alt_text || 'Product Image';
            
            return `
                <div class="detailed-order-item">
                    <div class="item-image">
                        <img src="${imageUrl}" alt="${altText}" loading="lazy"
                             onerror="this.src='assets/default-product.jpg'">
                    </div>
                    <div class="item-info">
                        <div class="item-name">${item.product_name || `Product ${item.product_id}`}</div>
                        <div class="item-sku">SKU: ${item.product_variant_id}</div>
                        <div class="item-qty">Quantity: ${item.quantity}</div>
                        <div class="item-status">
                            Status: <span class="status-badge">${item.status}</span>
                        </div>
                    </div>
                    <div class="item-price">
                        <div class="price-unit">₹${parseFloat(item.price).toFixed(2)} each</div>
                        <div class="price-total">₹${parseFloat(item.subtotal).toFixed(2)} total</div>
                    </div>
                </div>
            `;
        }
        
        // Track specific order
        function trackSpecificOrder(orderNumber) {
            showToast(`Tracking order #${orderNumber}... This feature will be implemented soon!`);
        }
        
        // Initialize modal
        function initModal() {
            const modal = document.getElementById('orderDetailsModal');
            const closeBtn = document.getElementById('closeModal');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                });
            }
            
            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        // Show error message
        function showError(element, message) {
            element.textContent = message;
            element.style.display = 'block';
        }
        
        // Hide error message
        function hideError(element) {
            element.style.display = 'none';
        }
        
        // Show toast notification
        function showToast(message) {
            // Remove existing toast if any
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #3b82f6;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: fadeInOut 3s ease-in-out;
            `;
            
            document.body.appendChild(toast);
            
            // Remove toast after animation
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
    </script>
</body>
</html>